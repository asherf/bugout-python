from typing import Any, Dict, List, Optional, Tuple, Union
import uuid

from . import data
from . import calls
from .group import Group
from .journal import Journal
from .user import User


class InvalidParameters(ValueError):
    """
    Raised when provided invalid parameters.
    """


class Bugout:
    def __init__(
        self, brood_api_url: Optional[str] = None, spire_api_url: Optional[str] = None
    ) -> None:
        self.brood_api_url = brood_api_url
        self.spire_api_url = spire_api_url

        self.user = User(self.brood_api_url)
        self.group = Group(self.brood_api_url)
        self.journal = Journal(self.spire_api_url)

    @property
    def brood_url(self):
        return self.brood_api_url

    @property
    def spire_url(self):
        return self.spire_api_url

    def brood_ping(self) -> Dict[str, str]:
        if self.brood_api_url is None:
            raise InvalidParameters("Brood API url should be provided")
        return calls.ping(self.brood_api_url)

    def spire_ping(self) -> Dict[str, str]:
        if self.spire_api_url is None:
            raise InvalidParameters("Spire API url should be provided")
        return calls.ping(self.spire_api_url)

    # User handlers
    def get_user(self, token: uuid.UUID) -> data.BugoutUser:
        return self.user.get_user(token)

    def create_user(
        self,
        username: str,
        email: str,
        password: str,
        autogenerated_token: str = None,
    ) -> data.BugoutUser:
        return self.user.create_user(
            username, email, password, autogenerated_token=autogenerated_token
        )

    # Token handlers
    def create_token(self, username: str, password: str) -> data.BugoutToken:
        return self.user.create_token(username, password)

    def revoke_token(self, token: uuid.UUID) -> data.BugoutToken:
        return self.user.revoke_token(token)

    def revoke_token_by_id(self, token: uuid.UUID) -> data.BugoutToken:
        return self.user.revoke_token_by_id(token)

    def update_token(
        self,
        token: uuid.UUID,
        token_type: Optional[data.TokenType] = None,
        token_note: Optional[str] = None,
    ) -> data.BugoutToken:
        return self.user.update_token(token, token_type, token_note)

    def get_token_types(self, token: uuid.UUID) -> List[str]:
        return self.user.get_token_types(token)

    def get_user_tokens(
        self,
        token: uuid.UUID,
        active: Optional[bool] = None,
        token_type: Optional[data.TokenType] = None,
    ):
        return self.user.get_user_tokens(token, active, token_type)

    # Group handlers
    def get_group(self, group_id: uuid.UUID, token: uuid.UUID) -> data.BugoutGroup:
        return self.group.get_group(group_id, token)

    # Journal handlers
    def get_journal(
        self, journal_id: uuid.UUID, token: uuid.UUID
    ) -> data.BugoutJournal:
        return self.journal.get_journal(journal_id, token)
